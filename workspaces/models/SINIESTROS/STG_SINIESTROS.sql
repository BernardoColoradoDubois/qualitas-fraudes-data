CREATE OR REPLACE TABLE `{{task.params.DEST_PROJECT_ID}}.{{task.params.DEST_DATASET_NAME}}.{{task.params.DEST_TABLE_NAME}}` AS
( 
WITH S AS (
  SELECT
    Z_ID,
    REPORTE,
    POLIZA,
    ENDOSO,
    INCISO,
    ASEGURADO,
    ID_ASEG,
    CAUSA,
    HOR_OCU,
    HOR_REP,
    HOR_REG,
    FEC_INI_VIG,
    MARCA,
    MODELO,
    SERIE,
    SEVERIDAD,
    ESTATUS,
    RESERVA,
    UBICACION,
    ENTIDAD,
    OFICINA,
    LEIDO_SAS,
    OFICINA_DE_ATENCION,
    ID_AJUSTADOR,
    LATITUD,
    LONGITUD,
    CONDUCTOR,
    COD_USO,
    USO,
    SUMA_ASEG,
    PLACA,
    FEC_EMI,
    POL_REHAB,
    FEC_FIN_VIG,
    OBSERVACIONES,
    BATCHDATE,
    SYSUSERID,
    ROW_NUMBER() OVER (PARTITION BY Z_ID ORDER BY HOR_OCU DESC) AS REPETIDO
  FROM `{{task.params.SOURCE_PROJECT_ID}}.{{task.params.SOURCE_DATASET_NAME}}.{{task.params.SOURCE_TABLE_NAME}}`
)
SELECT
  Z_ID,
  REPORTE,
  POLIZA,
  ENDOSO,
  INCISO,
  ASEGURADO,
  ID_ASEG,
  CAUSA,
  HOR_OCU,
  HOR_REP,
  HOR_REG,
  FEC_INI_VIG,
  MARCA,
  MODELO,
  SERIE,
  SEVERIDAD,
  ESTATUS,
  RESERVA,
  UBICACION,
  ENTIDAD,
  OFICINA,
  LEIDO_SAS,
  OFICINA_DE_ATENCION,
  ID_AJUSTADOR,
  LATITUD,
  LONGITUD,
  CONDUCTOR,
  COD_USO,
  USO,
  SUMA_ASEG,
  PLACA,
  FEC_EMI,
  POL_REHAB,
  FEC_FIN_VIG,
  OBSERVACIONES,
  BATCHDATE,
  SYSUSERID,
FROM S WHERE REPETIDO = 1
)